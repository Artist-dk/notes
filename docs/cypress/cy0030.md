# **ğŸ” Session Management in Cypress: Preserving Cookies & Local Storage**  

Session management in Cypress ensures that authentication and user state persist across tests, preventing repetitive logins and maintaining test efficiency. This guide explores **preserving cookies, local storage, and using `cy.session()` for state persistence.**  

---

## **ğŸ“Œ 1ï¸âƒ£ Why Manage Sessions in Cypress?**  

âœ… **Avoid Repetitive Logins** â†’ Speeds up test execution.  
âœ… **Preserve User State** â†’ Maintain authentication, theme preferences, and saved settings.  
âœ… **Prevent Unnecessary API Calls** â†’ Reduces load on backend services.  
âœ… **Improve Test Stability** â†’ Avoids flakiness due to frequent logins.  

---

## **ğŸ“Œ 2ï¸âƒ£ Cypress Session Management Features**  

Cypress provides several ways to **manage user sessions and authentication tokens**:  

ğŸ”¹ **Cookies** â†’ Store session-based authentication tokens.  
ğŸ”¹ **Local Storage** â†’ Save persistent tokens (JWT, API keys, etc.).  
ğŸ”¹ **Session Storage** â†’ Store temporary session data.  
ğŸ”¹ **`cy.session()`** â†’ Cache session across multiple tests (Cypress v9.6+).  

---

## **ğŸ“Œ 3ï¸âƒ£ Method 1: Preserving Cookies in Cypress**  

Cookies store **session IDs, authentication tokens, and preferences**. By default, Cypress clears cookies between tests, but we can preserve them.  

### **âœ… Preserve Cookies for All Tests (Using `Cypress.Cookies.defaults()`)**  
```javascript
Cypress.Cookies.defaults({
  preserve: ['session_id', 'auth_token'] // Replace with actual cookie names
});
```
âœ” **Prevents Cypress from clearing session cookies between tests.**  

### **âœ… Preserve Cookies Per Test Suite (Using `cy.getCookie()` & `cy.setCookie()`)**  
```javascript
describe('Preserve Cookies Example', () => {
  beforeEach(() => {
    cy.setCookie('session_id', 'your-session-value'); // Set cookie before each test
  });

  it('Check Session Persistence', () => {
    cy.getCookie('session_id').should('exist'); // Verify session is stored
  });
});
```

---

## **ğŸ“Œ 4ï¸âƒ£ Method 2: Preserving Local Storage**  

Local storage is often used to store **authentication tokens (JWT), theme preferences, or user data**. Cypress clears local storage between tests by default.  

### **âœ… Preserve Local Storage Manually**  
```javascript
let localStorageBackup = {};

beforeEach(() => {
  cy.window().then((win) => {
    localStorageBackup = { ...win.localStorage };
  });
});

afterEach(() => {
  cy.window().then((win) => {
    Object.keys(localStorageBackup).forEach((key) => {
      win.localStorage.setItem(key, localStorageBackup[key]);
    });
  });
});
```
âœ” **Restores local storage before and after each test.**  

### **âœ… Preserve Local Storage Per Test**  
```javascript
describe('Local Storage Persistence', () => {
  beforeEach(() => {
    cy.window().then((win) => {
      win.localStorage.setItem('authToken', 'your-token-here');
    });
  });

  it('Check Local Storage', () => {
    cy.window().then((win) => {
      expect(win.localStorage.getItem('authToken')).to.eq('your-token-here');
    });
  });
});
```

---

## **ğŸ“Œ 5ï¸âƒ£ Method 3: Using `cy.session()` for Persistent Authentication**  

From Cypress **v9.6+**, `cy.session()` allows caching authentication data across multiple tests, avoiding repetitive logins.  

### **âœ… Example: Using `cy.session()` to Cache Authentication**  
```javascript
Cypress.Commands.add('loginWithSession', () => {
  cy.session('userSession', () => {
    cy.request({
      method: 'POST',
      url: '/api/login',
      body: { email: 'testuser@example.com', password: 'password123' }
    }).then((response) => {
      expect(response.status).to.eq(200);
      window.localStorage.setItem('authToken', response.body.token);
    });
  });
});

describe('Session-Based Authentication', () => {
  beforeEach(() => {
    cy.loginWithSession(); // Reuse session before each test
  });

  it('Access dashboard without logging in again', () => {
    cy.visit('/dashboard');
    cy.contains('Welcome, Test User').should('be.visible');
  });
});
```
âœ” **Pros:** Faster tests, no repeated logins.  
âŒ **Cons:** Requires Cypress **v9.6+**.  

---

## **ğŸ“Œ 6ï¸âƒ£ Method 4: Using Cypress Environment Variables for Authentication**  

Instead of hardcoding authentication tokens, use **environment variables (`Cypress.env()`)** to manage sessions securely.  

### **âœ… Setting Up Environment Variables (`cypress.config.js`)**  
```javascript
module.exports = {
  e2e: {
    env: {
      apiBaseUrl: 'https://api.example.com',
      authToken: 'your-token-here'
    }
  }
};
```

### **âœ… Using Environment Variables in Tests**  
```javascript
describe('Using Environment Variables', () => {
  it('Logs in using stored token', () => {
    cy.request({
      method: 'POST',
      url: Cypress.env('apiBaseUrl') + '/login',
      body: {
        email: 'testuser@example.com',
        password: 'password123'
      }
    }).then((response) => {
      Cypress.env('authToken', response.body.token);
    });

    cy.visit('/dashboard', {
      headers: {
        Authorization: `Bearer ${Cypress.env('authToken')}`
      }
    });

    cy.contains('Dashboard').should('be.visible');
  });
});
```
âœ” **Keeps tokens secure & configurable.**  

---

## **ğŸ“Œ 7ï¸âƒ£ Best Practices for Session Management in Cypress**  

âœ… **Use `cy.session()`** â†’ Best for caching login sessions across tests.  
âœ… **Preserve cookies** when dealing with session-based authentication.  
âœ… **Store tokens in `localStorage`** for persistent authentication.  
âœ… **Use environment variables (`Cypress.env()`)** for authentication data.  
âœ… **Avoid logging in multiple times per test** â†’ Use API login or session reuse.  
âœ… **Handle token expiration** by refreshing expired tokens before tests.  

---

## **ğŸ“Œ 8ï¸âƒ£ Summary: Which Session Management Method Should You Use?**  

| **Method** | **Use Case** | **Pros** | **Cons** |
|------------|-------------|----------|----------|
| **Preserving Cookies** | Session-based authentication | Works with traditional login systems | Requires setting up cookie names |
| **Local Storage** | JWT authentication, user preferences | Easy to persist across tests | May require manual reset between tests |
| **cy.session()** | Fast authentication reuse | Drastically speeds up tests | Only available in Cypress v9.6+ |
| **Environment Variables** | Securely storing tokens | Avoids hardcoding credentials | Requires setup in config files |

---

## **ğŸš€ Whatâ€™s Next?**  

Would you like:  
âœ” **Handling Token Expiry & Refresh Tokens in Cypress?**  
âœ” **Multi-User Session Management (Switching Between Users)?**  
âœ” **Testing Logout Functionality & Session Expiry?**  

Let me know! ğŸ˜ŠğŸ”¥